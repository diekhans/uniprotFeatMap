#!/bin/bash
set -beEu -o pipefail
usage="$0 targetDb queryFa outPsl"

# must match decoratorConf.py
blastDir=/cluster/bin/blast/x86_64/blast-2.2.16/bin
blastAll=${blastDir}/blastall

if [ $# != 3 ] ; then
    echo "Wrong # args: $usage" >&2
    exit 1
fi
targetDb="$1"
queryFa="$2"
outPsl="$3"

mkdir -p $(dirname ${outPsl})
outPslTmp=$outPsl.$(hostname).$$.tmp

# keep + strand with same acc
function filter() {
    tawk '$9 == "+" && gensub("^([A-Z0-9]+).*$", "\\1", 1, $10) == gensub("^([A-Z0-9]+).*$", "\\1", 1, $14)'
}


${blastAll} -p blastp -F F -d $targetDb -i $queryFa | blastToPsl /dev/stdin /dev/stdout | filter > $outPslTmp
#blat -noHead -prot $targetDb $queryFa /dev/stdout | filter >$outPslTmp

mv -f $outPslTmp $outPsl
