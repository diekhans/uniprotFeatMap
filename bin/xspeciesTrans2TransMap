#!/usr/bin/env python3

import os
import os.path as osp
import sys
import argparse
import pipettor
from pycbio.sys import fileOps

sys.path.insert(0, osp.normpath(osp.join(osp.dirname(__file__), "../lib")))
from uniprotmap.mapping import pslMapMkCmd

# Algorithm
#  - srcMRnaAln  -> srcTargetGenome -> srcMRnaTargetGenomeAln
#  - srcMRnaTargetGenomeAln -> targetMRnaGenomeAln -> srcTargetMRnaAln
#

def parseArgs():
    desc = """Create cross-species source mRNA to target mRNA alignments
    via transmap"""

    parser = argparse.ArgumentParser(description=desc)
    parser.add_argument("srcMRnaPsl",
                        help="""source inferred mRNA alignments""")
    parser.add_argument("srcMRnaFa",
                        help="""source mRNA sequences""")
    parser.add_argument("mappingChains",
                        help="""alignment chains between species""")
    parser.add_argument("targetMRnaPsl",
                        help="""target species inferred alignments""")
    parser.add_argument("targetMRnaFa",
                        help="""target species mRNA sequences""")
    parser.add_argument("srcTargetMRnaPsl",
                        help="""alignments of source to target transcripts """)
    return parser.parse_args()


def transMapPipeline(srcMRnaPsl, srcMRnaFa, mappingChains,
                     targetMRnaPsl, targetMRnaTwoBit, srcTargetMRnaPsl):
    cmds = (pslMapMkCmd(srcMRnaPsl, mappingChains, "/dev/stdout", chainMapFile=True) +
            pslMapMkCmd("/dev/stdin", targetMRnaPsl, "/dev/stdout", swapMap=True) +
            [["pslMapPostChain", "/dev/stdin", "/dev/stdout"],
             ["pslRecalcMatch", "/dev/stdin", targetMRnaTwoBit, srcMRnaFa, "/dev/stdout"],
             ["sort", "-k10,10", "-k12,12n"]])
    pipettor.run(cmds, stdout=srcTargetMRnaPsl)

def xspeciesTrans2TransMap(srcMRnaPsl, srcMRnaFa, mappingChains,
                           targetMRnaPsl, targetMRnaFa, srcTargetMRnaPsl):
    tmpTargetMRnaTwoBit = fileOps.tmpFileGet("rnatwobit")
    try:
        pipettor.run(["faToTwoBit", "-long", targetMRnaFa, tmpTargetMRnaTwoBit])
        transMapPipeline(srcMRnaPsl, srcMRnaFa, mappingChains,
                         targetMRnaPsl, tmpTargetMRnaTwoBit, srcTargetMRnaPsl)
    finally:
        os.unlink(tmpTargetMRnaTwoBit)

def main(opts):
    xspeciesTrans2TransMap(opts.srcMRnaPsl, opts.srcMRnaFa, opts.mappingChains,
                           opts.targetMRnaPsl, opts.targetMRnaFa, opts.srcTargetMRnaPsl)


main(parseArgs())
