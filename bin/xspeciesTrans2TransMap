#!/usr/bin/env python3

import os
import os.path as osp
import sys
import argparse
import pipettor
from pycbio.sys import fileOps

sys.path.insert(0, osp.normpath(osp.join(osp.dirname(__file__), "../lib")))
from uniprotmap.mapping import pslMapMkCmd

# Algorithm
#  - srcTransTargetGenomeAln -> targetMRnaGenomeAln -> srcTargetMRnaAln
#

def parseArgs():
    desc = """Create cross-species source mRNA to target mRNA alignments
    via transmap"""

    parser = argparse.ArgumentParser(description=desc)
    parser.add_argument("srcTrans2TargetGenomePsl",
                        help="""source mRNA alignments""")
    parser.add_argument("srcTransFa",
                        help="""source mRNA sequences""")
    parser.add_argument("targetTrans2GenomePsl",
                        help="""target assemble inferred mRNA to genome alignments""")
    parser.add_argument("targetTransFa",
                        help="""target assembly mRNA sequences""")
    parser.add_argument("srcTrans2TargetTransPsl",
                        help="""alignments of source to target transcripts """)
    return parser.parse_args()


def transMapPipeline(srcTrans2TargetGenomePsl, srcTransFa, targetTrans2GenomePsl, targetMRnaTwoBit, srcTrans2TargetTransPsl):
    cmds = (pslMapMkCmd(srcTrans2TargetGenomePsl, targetTrans2GenomePsl, "/dev/stdout", swapMap=True) +
            [["pslMapPostChain", "/dev/stdin", "/dev/stdout"],
             ["pslRecalcMatch", "/dev/stdin", targetMRnaTwoBit, srcTransFa, "/dev/stdout"],
             ["sort", "-k10,10", "-k12,12n"]])
    pipettor.run(cmds, stdout=srcTrans2TargetTransPsl)

def xspeciesTrans2TransMap(srcTrans2TargetGenomePsl, srcTransFa, targetTrans2GenomePsl, targetTransFa,
                           srcTrans2TargetTransPsl):
    tmpTargetMRnaTwoBit = fileOps.tmpFileGet("rnatwobit")
    try:
        pipettor.run(["faToTwoBit", "-long", targetTransFa, tmpTargetMRnaTwoBit])
        transMapPipeline(srcTrans2TargetGenomePsl, srcTransFa, targetTrans2GenomePsl,
                         tmpTargetMRnaTwoBit, srcTrans2TargetTransPsl)
    finally:
        os.unlink(tmpTargetMRnaTwoBit)

def main(args):
    xspeciesTrans2TransMap(args.srcTrans2TargetGenomePsl, args.srcTransFa, args.targetTrans2GenomePsl,
                           args.targetTransFa, args.srcTrans2TargetTransPsl)


main(parseArgs())
