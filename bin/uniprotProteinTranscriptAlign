#!/usr/bin/env python3

import sys
import os.path as osp
import argparse
import re
import functools
from pycbio.sys import fileOps

sys.path.insert(0, osp.normpath(osp.join(osp.dirname(__file__), "../lib")))
from uniprotmap import prMsg
from uniprotmap.depends import runIfNotDone, runIfOutOfDate
from uniprotmap.align import queryBuildDb, targetBuildDb, combinePairAligns, runBatch
from uniprotmap.uniprot import UniProtMetaTbl, dropUniportIsoformModifier

uniprotProteinTranscriptAlignJob = osp.join(osp.dirname(__file__), "uniprotProteinTranscriptAlignJob")

def parseArgs():
    desc = """Align UniProt protein sequences to UniProt canonical transcripts
    RNAs with BLAT or BLAST.  Creates a protein to NA PSL alignments, with
    some basic filtering.  UTR is hard masked to prevent alignment outside of
    CDS without changing sequence size.

    Program can be rerun to finish up after manual parasol recovery. After a
    failure is connect and jobs finished, touch ${workdir}/aligns.done and
    rerun this program.
    """
    parser = argparse.ArgumentParser(description=desc)
    parser.add_argument("--algo", choices=("blast", "blat"), default="blat",
                        help="alignment algorithm")
    parser.add_argument("uniprotMetaTsv",
                        help="""Uniprot metadata in TSV format (input)""")
    parser.add_argument("uniprotFa",
                        help="""UniProt FASTA (input)""")
    parser.add_argument("transFa",
                        help="""transcript FASTA, CDS must be in upper-case and UTR in lowercase (input)""")
    parser.add_argument("protCanonTransPsl",
                        help="""alignments of UniProt proteins to their canonical transcripts, sorted by transcript (output)""")
    parser.add_argument("workDir",
                        help="temporary directory used by parasol run")
    return parser.parse_args()

def queryFaEditFilter(faRec):
    """Select canonical isoform records.  They which have headers like
    >P14060 isRefOf P14060
    """
    return re.match("^.+ isRefOf .+$", faRec.description) is not None

def isCanonicalProtMRnaAlign(uniprotMetaTbl, psl):
    """Only keep alignments from canonical SwissProt isoform, as alt-isoforms to
    a canonical transcript"""
    uniprotMeta = uniprotMetaTbl.getByAcc(dropUniportIsoformModifier(psl.qName))
    return ((psl.qName == uniprotMeta.mainIsoAcc) and uniprotMeta.isCanonProtTrans(psl.tName))

def proteinTranscriptAlign(uniprotMetaTsv, uniprotFa, transFa, protCanonTransPsl, algo, workDir):
    uniprotMetaTbl = UniProtMetaTbl(uniprotMetaTsv)
    targetDir = osp.join(workDir, "transDb")
    transDbFa = osp.join(targetDir, "transDb.fa")
    with runIfNotDone(targetDir, depends=transFa) as do:
        if do:
            prMsg("building target transcript database")
            targetBuildDb(uniprotMetaTbl.isCanonProtTrans, transFa, transDbFa, algo, targetDir)

    queryDir = osp.join(workDir, "queryDir")
    with runIfNotDone(queryDir, depends=uniprotFa) as do:
        if do:
            prMsg("split UniProt proteins")
            queryBuildDb(uniprotFa, queryDir)

    alignDir = osp.join(workDir, "aligns")
    with runIfNotDone(alignDir, doneDepends=[targetDir, queryDir]) as do:
        if do:
            prMsg("running alignment batch")
            runBatch([uniprotProteinTranscriptAlignJob, algo], queryDir, transDbFa, alignDir,
                     osp.join(workDir, "batch"))

    with runIfOutOfDate(protCanonTransPsl, doneDepends=alignDir) as do:
        if do:
            prMsg("combining alignments")
            with fileOps.AtomicFileCreate(protCanonTransPsl) as tmpPsl:
                combinePairAligns(alignDir, tmpPsl, functools.partial(isCanonicalProtMRnaAlign, uniprotMetaTbl))
    prMsg("finished")

def main(opts):
    proteinTranscriptAlign(opts.uniprotMetaTsv, opts.uniprotFa, opts.transFa,
                           opts.protCanonTransPsl, opts.algo, opts.workDir)

main(parseArgs())
