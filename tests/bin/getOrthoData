#!/bin/bash
set -beEu -o pipefail

##
# see README.org 
##

gencodeRel=43

usage="$0 transacctsv outdir"

if [ $# != 2 ] ; then
    echo "Wrong # args: $usage" >&2
    exit 1
fi
transacctsv="$1"
outdir="$2"

target_asmname=ponAbe-GCA_028885655.2
target_asmacc=GCA_028885655.2
target_asmscc_parts=GCA/028/885/655

xspecies_rootdir=/hive/users/markd/gencode/projs/cls/cls-t2t-primate/hg38/data/assemblies
xspecies_url=https://public.gi.ucsc.edu/~pnhebbar/t2t_autosomes/assemblyHub
xspecies_genark_url=https://hgdownload.soe.ucsc.edu/hubs/${target_asmscc_parts}/${target_asmacc}

target_catbb=${xspecies_url}/${target_asmacc}/tm.bb
target_genome=${xspecies_genark_url}/${target_asmacc}.2bit

src_asmname=hg38
src_genome=/hive/data/genomes/hg38/hg38.2bit
src_chromSizes=/hive/data/genomes/hg38/chrom.sizes

src_target_chains=${xspecies_rootdir}/${target_asmname}/${src_asmname}-${target_asmname}.chain.gz

out_bigcat=${outdir}/${target_asmname}.cat.bigCat
out_catfa=${outdir}/${target_asmname}.cat.fa
out_catpsl=${outdir}/${target_asmname}.cat.psl
out_scr_target_chains=${outdir}/${target_asmname}.chains

mkdir -p ${outdir}

target_chromsizes_tmp=${outdir}/target.chrom.sizes.tmp
twoBitInfo ${target_genome} ${target_chromsizes_tmp}


# sourceTranscript  22
bigBedToBed ${target_catbb} /dev/stdout | \
    selectById -tsv -novers 1 ${transacctsv} 22 /dev/stdin > ${out_bigcat}

twoBitToFa -bed=<(cut -f 1-12 ${out_bigcat}) ${target_genome} ${out_catfa}

bedToPsl -tabs ${target_chromsizes_tmp} ${out_bigcat} /dev/stdout | \
    pslRecalcMatch /dev/stdin ${target_genome} ${out_catfa} ${out_catpsl}

overlapSelect -selectFmt=bed -inFmt=chain ${out_bigcat} -inFmt=chain ${src_target_chains} ${out_scr_target_chains}

rm -f ${outdir}/*.tmp
